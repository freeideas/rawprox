# Untested Req
**Timestamp:** 2025-11-02-13-35-12

---

## Prompt

Please follow these instructions: @./the-system/prompts/WRITE_TEST.md

Create test for requirement:
  $REQ_ID: $REQ_ARGS_002
  Flow file: reqs\mcp-dynamic-control.md
  Source: ./README.md (Section: "Usage"), ./readme/MCP_SERVER.md (Section: "Start-up Behavior")
  Requirement text: When started with `--mcp` flag but without port rules, RawProx must NOT show usage message (since MCP server is running) and must wait for MCP commands to add port rules.


---

## Response

Created test file: `./tests/failing/test_mcp_dynamic_control.py`

**Flow tested:** MCP Dynamic Control Flow (`reqs/mcp-dynamic-control.md`)

**Requirements covered:**
- $REQ_MCP_026: Start with MCP flag
- $REQ_ARGS_002: No port rules with MCP (no usage message, waits for commands)
- $REQ_MCP_027: Random port selection (10000-65500)
- $REQ_MCP_021: Listen on localhost
- $REQ_MCP_028: Emit start-mcp event only with flag
- $REQ_MCP_004: Start MCP event format
- $REQ_MCP_006: JSON-RPC responses
- $REQ_MCP_019: Success response format
- $REQ_MCP_034: Error response format
- $REQ_MCP_007, $REQ_MCP_008: start-logging method and parameters
- $REQ_STDOUT_011: Start logging event for STDOUT
- $REQ_MCP_030, $REQ_MCP_031: add-port-rule method and parameters
- $REQ_STDOUT_014: Connection open events
- $REQ_STDOUT_019: Traffic data events
- $REQ_PROXY_020: Forward traffic bidirectionally
- $REQ_MCP_011: Stop logging STDOUT
- $REQ_MCP_012: Stop logging specific directory
- $REQ_MCP_015, $REQ_MCP_016: remove-port-rule method and parameters
- $REQ_MCP_025: Remove port rule stops listener
- $REQ_MCP_032: Shutdown method
- $REQ_SHUTDOWN_006: MCP shutdown stopping mechanism
- $REQ_MCP_033: Shutdown behavior

**Test approach:**
1. Starts RawProx with `--mcp` flag only (no port rules)
2. Verifies start-mcp event is emitted with valid port
3. Verifies MCP server is listening on localhost
4. Tests start-logging to STDOUT via JSON-RPC
5. Creates echo server and adds port rule dynamically
6. Verifies proxy accepts connections and forwards traffic bidirectionally
7. Verifies connection and traffic events are logged
8. Tests stop-logging for STDOUT
9. Tests start-logging to directory with filename format
10. Tests stop-logging for specific directory
11. Tests remove-port-rule and verifies listener stops
12. Tests error response for invalid method
13. Tests shutdown via JSON-RPC

