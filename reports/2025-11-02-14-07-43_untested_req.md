# Untested Req
**Timestamp:** 2025-11-02-14-07-43

---

## Prompt

Please follow these instructions: @./the-system/prompts/WRITE_TEST.md

Create test for requirement:
  $REQ_ID: $REQ_MCP_022
  Flow file: reqs\mcp-dynamic-control.md
  Source: ./readme/MCP_SERVER.md (Section: "Connection")
  Requirement text: MCP server must accept JSON-RPC requests over TCP/IP connections.


---

## Response

## Summary

**Test file updated:** `./tests/failing/test_mcp_dynamic_control.py`

**Flow tested:** MCP Dynamic Control Flow (`reqs/mcp-dynamic-control.md`)

**Requirement addressed:** $REQ_MCP_022 - "MCP server must accept JSON-RPC requests over TCP/IP connections"

**Requirements covered in this test (34 total):**
- REQ_ARGS_002, REQ_FILE_023, REQ_FILE_024
- REQ_MCP_004, REQ_MCP_006, REQ_MCP_007, REQ_MCP_008, REQ_MCP_009, REQ_MCP_010, REQ_MCP_011, REQ_MCP_012, REQ_MCP_015, REQ_MCP_016, REQ_MCP_019, REQ_MCP_021, REQ_MCP_022, REQ_MCP_023, REQ_MCP_025, REQ_MCP_026, REQ_MCP_027, REQ_MCP_028, REQ_MCP_029, REQ_MCP_030, REQ_MCP_031, REQ_MCP_032, REQ_MCP_033, REQ_MCP_034
- REQ_PROXY_015, REQ_PROXY_020
- REQ_SHUTDOWN_006
- REQ_STDOUT_011, REQ_STDOUT_012, REQ_STDOUT_014, REQ_STDOUT_019

**Test approach:**
1. Tests MCP server start-up with and without port rules ($REQ_MCP_023, $REQ_MCP_026)
2. Verifies JSON-RPC over TCP/IP communication ($REQ_MCP_022, $REQ_MCP_029) using the `send_jsonrpc_request()` helper
3. Tests all MCP JSON-RPC methods: start-logging, stop-logging, add-port-rule, remove-port-rule, shutdown
4. Validates bidirectional proxy traffic forwarding
5. Confirms proper event logging for all operations
6. Verifies error responses for invalid methods

**Key updates made:**
- Added explicit test for $REQ_MCP_023 (MCP with initial port rules)
- Tagged $REQ_MCP_022 and $REQ_MCP_029 on JSON-RPC TCP/IP communication assertion (line 153)
- Added `bufsize=1` to subprocess.Popen calls to ensure line-buffered output
- Fixed event reading sequence to account for `start-logging` event emitted before `start-mcp`
- Corrected timestamp field name from `timestamp` to `time`

