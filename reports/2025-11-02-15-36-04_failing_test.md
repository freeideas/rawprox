# Failing Test
**Timestamp:** 2025-11-02-15-36-04

---

## Prompt

Please follow these instructions: @./the-system/prompts/FIX_FAILING_TEST.md

Failing test: ./tests/failing\test_04_error_handling.py
Attempt: 1/10

Test output:
```
  Determining projects to restore...
  All projects are up-to-date for restore.
  rawprox -> C:\acex\prjx\rawprox.new\code\bin\Release\net8.0\win-x64\rawprox.dll
  rawprox -> C:\acex\prjx\rawprox.new\release\
Building rawprox from C:\acex\prjx\rawprox.new\code
Running: dotnet publish -c Release -r win-x64 --self-contained true -o C:\acex\prjx\rawprox.new\release
Removing unwanted artifact: rawprox.pdb

Build successful!
Artifact: C:\acex\prjx\rawprox.new\release\rawprox.exe
Size: 3.42 MB
Installed 5 packages in 53ms
Testing help display...
✗ Test failed: Expected no NDJSON on STDOUT

============================================================
Building project
============================================================


============================================================
Running test: ./tests/failing\test_04_error_handling.py
============================================================


============================================================
✗ Tests failed with exit code 1
============================================================


```


---

## Response

## Summary

**Test Failure Root Cause:**

The test `./tests/failing/test_04_error_handling.py` had three distinct failures:

1. **$REQ_ARGS_007 violation**: When `rawprox.exe` was run without arguments (to display help), it was outputting a `start-logging` NDJSON event to STDOUT. The requirement states that help text should only go to STDERR with no NDJSON on STDOUT.

2. **$REQ_MCP_003 ordering issue**: When starting in MCP mode, the `start-logging` event was being emitted before the `start-mcp` event. The test expected `start-mcp` to be the first event on STDOUT.

3. **$REQ_MCP_020/$REQ_MCP_024 missing implementation**: When the `add-port-rule` JSON-RPC method attempted to add a port rule for a port already in use, it was not returning a JSON-RPC error response.

**Fixes Implemented:**

1. **Moved help check before logging initialization** (c:\acex\prjx\rawprox.new\code\Program.cs:76-82): Validated arguments and exited for the help case BEFORE calling `StartLogging()`, preventing any NDJSON output to STDOUT.

2. **Emitted start-mcp event before starting logging** (c:\acex\prjx\rawprox.new\code\Program.cs:84-98): When `--mcp` flag is present, the MCP server is started and the `start-mcp` event is written directly to STDOUT (bypassing the queue) before the logging system initializes. This ensures `start-mcp` is always the first event.

3. **Added error handling for port conflicts in add-port-rule** (c:\acex\prjx\rawprox.new\code\Program.cs:591-607): The MCP server's `add-port-rule` handler now checks if `StartPortRule()` returns false and returns a JSON-RPC error response with code -32000 and a message indicating which port is occupied.

**Requirements Satisfied:**

- $REQ_ARGS_001: Help text to STDERR when no arguments
- $REQ_ARGS_006: Exit code 1 when showing help
- $REQ_ARGS_007: No NDJSON to STDOUT when displaying help
- $REQ_ARGS_003, $REQ_ARGS_004, $REQ_ARGS_005, $REQ_ARGS_012: Error handling for invalid arguments
- $REQ_MCP_001, $REQ_MCP_002, $REQ_MCP_003: MCP server startup and event emission
- $REQ_MCP_005, $REQ_MCP_013, $REQ_MCP_014: JSON-RPC protocol and add-port-rule method
- $REQ_MCP_020, $REQ_MCP_024: Error responses for port conflicts
- $REQ_MCP_017, $REQ_MCP_018: Shutdown method
- $REQ_STARTUP_005: Port conflict error handling
- $REQ_SHUTDOWN_002, $REQ_SHUTDOWN_003, $REQ_SHUTDOWN_004: Clean shutdown

**Test Results:**

All tests in `test_04_error_handling.py` now pass. The test has been moved from `./tests/failing/` to `./tests/`.

